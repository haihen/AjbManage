<!DOCTYPE html>
<html >
	<head>
		<meta charset="UTF-8">
		<link rel="shortcut icon" href="favicon.ico">
		<script type="text/javascript" src="/home/js/jquery-1.7.2.min.js"></script>
		<script type="text/javascript" src="/home/common/angular.js"></script>
		<script type="text/javascript" src="/home/common/compatibility.js"></script>
		<link type="text/css" rel="stylesheet" href="/home/css/global.css" />
		<link type="text/css" rel="stylesheet" href="/home/css/headFoot.css" />
		<link type="text/css" rel="stylesheet" href="/home/css/index.css"/>
		<link type="text/css" rel="stylesheet" href="/home/common/common.css"/>
		<link type="text/css" rel="stylesheet" href="/home/common/regist.css"/>
		<style>
			.msgs1 {
			    background: #E6E6E6;
			    color: #818080;
			    border: 1px solid #CCCCCC;
			}
			.msgs {
			    -webkit-border-radius: .5em;
			    -moz-border-radius: .5em;
			    border-radius: .5em;
			    display: inline-block;
			    width: 100px;
			    color: #fff;
			    font-size: 14px;
			    border: 1px solid #0697DA;
			    text-align: center;
			    height: 30px;
			    line-height: 30px;
			    background: #0697DA;
			    cursor: pointer;
			}
		</style>
	</head>
	<#include "/headLoad.html">
		<div class="min_h_500 ng-scope" style="margin-bottom: 30px;" ui-view=""><div class="w1200 auto mt20 ng-scope">
		    <!--<div class="t_bar mb10">-->
		    <!--<div class="person_ico">个人中心</div>-->
		    <!--<div class="clear"></div>-->
		    <!--</div>-->
		
		    <div class="w320 fl fixborder">
		        <div class="bgfff bb_e8 user_info_box">
		            <div class="user_mation" ui-sref="collectSource" href="#/zh-CN/userCenter/collectSource">
		                <div class="imgbox">
		                	<#if webUser.headImage!="">
		                		<img src="${webUser.headImage}">
		                	<#else>
		                		<img src="/home/images/headImg.png">
		                	</#if>
		                </div>
		                <p class="tac ng-binding">
							<#if webUser.userName!="">
							  ${webUser.userName}
							<#else>
							  ${webUser.loginName}
							</#if>
						</p>
		                <p class="tac ng-binding">积分：${webUser.points}</p>
		            </div>
		            <div>
		                <ul class="navtypeuser">
		                    <li href="#/zh-CN/userCenter/changeUserInfo" class="active">个人档案</li>
		                    <li href="#/zh-CN/userCenter/exchangeList" class="">积分兑换</li>
		                </ul>
		            </div>
		
		        </div>
		
		        <!--<div class="bgfff bb_e8 mt20 user_oa">-->
		            <!--<div ui-sref="message">尊敬的{{user.realName}},您好！您有<a>{{messageNum}}</a>条未读信息！</div>-->
		            <!--<span class="dot_red" ng-if="messageNum!=0"></span>-->
		        <!--</div>-->
		    </div>
		    <!------------------------------------------------------------------>
		    <!-- uiView:  -->
		    <div class="contentuser">
		    <div class="fr w860 ng-scope"><div class="ng-scope">
		
		    <div class="bgfff bb_e8 min_h_500 fixborder">
		        <ul class="navtype">
		            <li class="active"><a>信息修改</a></li>
		            <li><a>密码修改</a></li>
		        </ul>
		
				
				<div class="content">
		        <div class="register_2" style="display:block !important;">
					<form id="userForm" name="userForm" enctype="multipart/form-data">
						<input type="hidden" id="userId" name="userId" value="${webUser.userId}" >
			            <table cellpadding="0" cellspacing="0" border="0" style="margin:0;" class="ng-pristine ng-valid ng-valid-required">
			                <tbody><tr>
			                    <td align="right" width="20%"><span class="spanRed">*</span><label>用户名：</label></td>
			                    <td>
			                        <input id="loginNameA" type="text"  name="loginNameA" value="${webUser.loginName}"  maxlength="20" disabled="true" class="ng-pristine ng-valid ng-valid-required">
			                    	<input id="loginName" type="hidden"  name="loginName" value="${webUser.loginName}" >
			                    	<input id="streetValue" type="hidden"  name="streetValue" value="${webUser.street}" >
			                    </td>
			                </tr>
			                <tr>
				                <td align="right"><span style="color: red">*</span><label>所在街镇：</label></td>
				                <td>
				                    <select id="street" name="street" class="form-control ng-pristine ng-valid">
				                        <option value="杨柳青镇">杨柳青镇</option>
				                        <option value="中北镇">中北镇</option>
				                        <option value="张家窝镇">张家窝镇</option>
				                        <option value="精武镇">精武镇</option>
				                        <option value="大寺镇">大寺镇</option>
				                        <option value="辛口镇">辛口镇</option>
				                        <option value="王稳庄镇">王稳庄镇</option>
				                        <option value="西营门街道">西营门街道</option>
				                        <option value="李七庄街道">李七庄街道</option>
				                        <option value="赤龙南街道">赤龙南街道</option>
				                        <option value="其他">其他</option>
				                    </select>
				                </td>
				            </tr>
			                <tr>
			                    <td align="right"><label>真实姓名：</label></td>
			                    <td>
			                        <input id="userName" type="text"  name="userName" value="${webUser.userName}" maxlength="20" class="ng-scope ng-pristine ng-valid">
			                    </td>
			                </tr>
			                <tr>
			                    <td align="right"><label>头像：</label></td>
			                    <td>
			                        <input id="headImageFile" name="headImageFile" class="btn btn-default" type="file" ><br>
			                        <span>支持格式：jpg,jpeg,png,bmp</span>
			                    </td>
			                </tr>
			                <tr>
			                    <td align="right"><label></label></td>
			                    <td>
			                    	<#if webUser.headImage != "">
			                        	<img id="preview"  name="preview" alt="image" src="${webUser.headImage}" width="200px" >
			                        <#else>
			                        	<img id="preview"  name="preview" alt="image" src="/home/images/headImg.png" width="100px" >
			                        </#if>
			                    </td>
			                </tr>
			                <tr>
			                    <td align="right"><label>身份证号：</label></td>
			                    <td>
			                        <input id="idCard" type="text"  name="idCard" value="${webUser.idCard}" maxlength="20" class="ng-scope ng-pristine ng-valid ng-valid-pattern">
			                    </td>
			                </tr>
			                <tr>
			                    <td align="right"><span class="spanRed">*</span><label>手机号码：</label></td>
			                    <td>
			                        <input id="mobile" type="text" name="mobile" value="${webUser.mobile}" maxlength="20" class="ng-pristine ng-valid ng-valid-pattern">
			                        <br><font color="red">注意：手机号修改后将作为新的用户名！</font>
			                    </td>
			                </tr>
			                <tr>
				                <td align="right"><label>手机验证码：</label></td>
				                <td>
				                    <div style="position: relative;">
				                        <input id="smsCode" type="text" maxlength="20" class="form-control ng-pristine ng-valid" name="smsCode">
				                        <input type="button" id="fsdmsg" value="获取手机验证码" onclick="sendRand_oldMobile()" class="msgs" style="width:200px !important;">
				                    </div>
				                </td>
				            </tr>
			                <tr>
			                    <td align="right"><label>邮箱：</label></td>
			                    <td>
			                        <input id="email" type="text" name="email" value="${webUser.email}" maxlength="100" class="ng-pristine ng-valid ng-valid-email">
			                    </td>
			                </tr>
			                <tr>
			                    <td align="right"><label>联系地址：</label></td>
			                    <td>
			                        <input id="address" type="text" class="form-control ng-pristine ng-valid" name="address" value="${webUser.address}" maxlength="255">
			                    </td>
			                </tr>
			            </tbody></table>
			            <div class="form-group tac">
			                <a type="button" class="btn_green btn" onClick="xgyh();" id="doModifyUser" style="font-size:14px;padding-top:10px;width:130px !important;height:30px !important;">确认修改</a>
			                <a type="button" class="btn btn_blue" onClick="location='/home/grkj'" style="font-size:14px;padding-top:10px;width:130px !important;height:30px !important;">返回</a>
			            </div>
		            </form>
		        </div>

				<div class="register_2" style="display:none !important;">
				    <form id="mmForm" name="mmForm">
				    	<input type="hidden" id="lgName" name="lgName" value="${webUser.loginName}" >
			            <table cellpadding="0" cellspacing="0" border="0" style="margin:0;" class="ng-pristine ng-invalid ng-invalid-required">
			                <tbody><tr ng-init="showPwd=false">
			                    <td align="right"><span class="must">*</span><label>当前密码：</label></td>
			                    <td style="position: relative;"><input id="password" type="password" name="password" maxlength="20" required="required">
			                        <a style="position: absolute;left: 395px;top: 12px;" onClick="glyphicon('oldp');"><i id = "oldp" class="glyphicon glyphicon-eye-close"></i></a>
			                    </td>
			                </tr>
			                <tr ng-init="showPwd2=false">
			                    <td align="right"><span class="must">*</span><label>新密码：</label></td>
			                    <td style="position: relative;"><input id="newPassword" type="password" name="newPassword" maxlength="20">
			                        <a style="position: absolute;left:395px;top:12px;" onClick="glyphicon('newp');"><i id = "newp" class="glyphicon glyphicon-eye-close"></i></a>
			                    	<br><font color="red">密码(8-30位)中必须包含字母、数字、特殊字符</font>
			                    </td>
			                </tr>
			                <tr ng-init="showPwd3=false">
			                    <td align="right"><span class="must">*</span><label>重复密码：</label></td>
			                    <td style="position: relative;"><input id="newPassword2" type="password" name="newPassword2" maxlength="20">
			                        <a style="position: absolute;left:395px;top:12px;" onClick="glyphicon('newp2');"><i id = "newp2" class="glyphicon glyphicon-eye-close"></i></a>
			                    </td>
			                </tr>
			            </tbody></table>
			            <div class="form-group tac">
			
			                <a type="button" class="btn_green btn" onClick="xgmm();" id="doModifyMM" style="font-size:14px;padding-top:10px;width:130px !important;height:30px !important;">确认修改
			                </a>
			                <a type="button" class="btn btn_blue" onClick="location='/home/grkj'" style="font-size:14px;padding-top:10px;width:130px !important;height:30px !important;">返回</a>
			            </div>
		            </form>
		        </div>
		        </div>
		    </div>
		</div></div>
		<div class="fr w860 ng-scope">
			<div class="fixborder ng-scope">
			    <div class="bgfff bb_e8">
			            <ul class="my_scoreshow" style="width:100% !important;">
			                <li style="width:24%">
			                    <p>我的积分</p>
			
			                    <h1 class="ng-binding">${webUser.points}</h1>
			                </li>
			                <li style="width:24%">
			                    <p>可用积分</p>
			
			                    <h1 class="ng-binding">${webUser.points}</h1>
			                </li>
			                <li style="width:24%">
			                    <p>建设中。。。</p>
			
			                    <h1 class="ng-binding">0</h1>
			                </li>
			                <li>
			                    <p>建设中。。。</p>
			
			                    <h1 class="ng-binding">0</h1>
			                </li>
			
			            </ul>
			    </div>
			  </div>
			</div>
			</div>
		    <div class="clear"></div>
		</div></div>
	<#include "/foot.html">
	<script type="text/javascript">
		$(window).load(function(){
	        $(".content>div").eq(0).show().siblings().hide();
	    });

		$(".navtype>li").click(function () {
	        $(this).addClass("active").siblings().removeClass("active");
	        var index = $(this).index();
	        $(".content>div").eq(index).show().siblings().hide();
	    })

	    $(window).load(function(){
	        $(".contentuser>div").eq(0).show().siblings().hide();
	    });

		$(".navtypeuser>li").click(function () {
	        $(this).addClass("active").siblings().removeClass("active");
	        var index = $(this).index();
	        $(".contentuser>div").eq(index).show().siblings().hide();
	    });
		
		var streetObj = document.getElementById("street");
		var streetValue = document.getElementById("streetValue").value;
		for(var i=0; i<streetObj.options.length; i++){ 
			if(streetObj.options[i].value == streetValue){ 
				streetObj.options[i].selected = true; 
				break; 
			} 
		}
		
		function glyphicon(id) {
			if($("#"+id).attr("class").indexOf('close')>-1){
				$("#"+id).attr("class","glyphicon glyphicon-eye-open");
				if(id=='oldp'){
					document.getElementById("password").type = "text";
				} else if(id=='newp'){
					document.getElementById("newPassword").type = "text";
				} else if(id=='newp2'){
					document.getElementById("newPassword2").type = "text";
				}
			} else if($("#"+id).attr("class").indexOf('open')>-1){
				$("#"+id).attr("class","glyphicon glyphicon-eye-close");
				if(id=='oldp'){
					document.getElementById("password").type = "password";
				} else if(id=='newp'){
					document.getElementById("newPassword").type = "password";
				} else if(id=='newp2'){
					document.getElementById("newPassword2").type = "password";
				}
			}			
		}
		
		$("#headImageFile").change(function () {
			var headImage = $("#headImageFile").val();
			if (!$.trim(headImage)) {
				return;
			}
			var i = headImage.lastIndexOf('.');
			var len = headImage.length;
			var str = headImage.substring(len, i + 1);
			var extName = "JPG,JPEG,PNG,BMP";
			if (extName.indexOf(str.toUpperCase()) < 0) {
				alert("请上传图片文件!");
				return;
			}
			
			var $file = $(this);
			var fileObj = $file[0];
			var windowURL = window.URL || window.webkitURL;
			var dataURL;
			var $img = $("#preview");
			if (fileObj && fileObj.files && fileObj.files[0]) {
				dataURL = windowURL.createObjectURL(fileObj.files[0]);
				$img.attr('src', dataURL);
		    } else {
		    	
				dataURL = $file.val();
			 	$img.attr('src', dataURL);
		 	}

	  	});
		
		function xgyh(){
			//手机号规则
			var mobileReg = /^(((13[0-9]{1})|(14[0-9]{1})|(17[0-3]{1})|(17[6-8]{1})|(15[0-3]{1})|(15[5-9]{1})|(18[0-9]{1}))+\d{8})$/;
			
			var loginName = $("#loginName").val();
			var userName = $("#userName").val();
			var idCard = $("#idCard").val();
			var mobile = $("#mobile").val();
			var email = $("#email").val();
			var address = $("#address").val();
			var street = $("#street").val();
			var smsCode = $("#smsCode").val();

			if(!street){
				alert('请输入所在街镇！');
				$('#street').focus();
				return;
			}
			if(!mobile){
				alert('请输入手机号码！');
				$('#mobile').focus();
				return;
			} else {
				if (mobile.length != 11) {
					alert('请输入有效的手机号码作为用户名！');
					$('#mobile').focus();
					return;
				} else if (!mobileReg.test(mobile)) {
					alert('请输入有效的手机号码作为用户名！');
					$('#mobile').focus();
					return;
				}
				if(mobile!=loginName && !smsCode){
					alert('请输入新手机号的验证码！');
					$('#smsCode').focus();
					return;
				}
			}
			
			var formData = new FormData($('#userForm')[0]);

			$.ajax({
				cache : true,
				type : 'POST',
				url : '/home/updateUserWeb',
				data : formData,
				async : false,
				processData : false,
		        contentType: false,
				success : function(data) {
					var code = data.code;						
					if (code == 0) {
						alert('修改个人信息成功！');
						window.location.href="/home/grkj";
/* 						//修改APP端用户
						var enc = data.enc;
						var uname = data.uname;
						var auth = data.auth;
						var idCard = data.idCard;
						var email = data.email;
						var params = {
								'uname' : uname,
								'enc' : enc,
								'auth' : auth,
								'idCard' : idCard,
								'email' : email
							};
						$.ajax({
							cache : true,
							type : "POST",
							url : "http://passport.tianfang.xuexi365.com/api/user/modify_info",
							data : params,// 你的formid
							async : false,
							dataType: "jsonp",
							error : function(request) {
								alert("修改APP用户失败，连接超时！");
							},
							success : function(data) {
								if (data.ret == true) {
									window.location.href="/home/grkj";
								} else {
									alert("修改APP用户失败！");
								}
				
							}
						}); */
					} else {
						alert(data.msg);
					}
				},
				error : function(XMLHttpRequest, textStatus, errorThrown) {
					alert("服务器错误，请稍后重试！");
				}
			}); 
		}

		function xgmm(){
			var loginName = $("#lgName").val();
			var password = $("#password").val();
			var newPassword = $("#newPassword").val();
			var newPassword2 = $("#newPassword2").val();

			if(!password){
				alert('请输入用户当前密码！');
				$('#password').focus();
				return;
			}
			
			if(!newPassword){
				alert('请输入用户新密码！');
				$('#newPassword').focus();
				return;
			} else {
				if(password==newPassword){
					alert('原密码和新密码不能一样！');
					$('#newPassword').focus();
					return;
				}
				var pwdRegex = new RegExp('(?=.*[0-9])(?=.*[a-zA-Z])(?=.*[^a-zA-Z0-9]).{8,30}');
				if(!pwdRegex.test(newPassword)){
					alert("您的密码安全级别低（密码中必须包含字母、数字、特殊字符），请及时修改密码！");
					$('#newPassword').focus();
					return;
				}
			}
			
			if(!newPassword2){
				alert('请输入用户确认新密码！');
				$('#newPassword2').focus();
				return;
			}
			
			if(newPassword!=newPassword2){
				alert('新密码不一致！');
				$('#newPassword2').focus();
				return;
			}
			
			var params = {
					'loginName' : loginName,
					'password' : password,
					'newPassword' : newPassword
				};

			$.ajax({
				cache : true,
				type : 'POST',
				url : '/home/updateMMWeb',
				data : params,
				async : false,
				success : function(data) {
					var code = data.code;						
					if (code == 0) {
						alert('修改个人密码成功！');
						window.location.href="/home/grkj";
					} else {
						alert(data.msg);
					}
				},
				error : function(XMLHttpRequest, textStatus, errorThrown) {
					alert("服务器错误，请稍后重试！");
				}
			}); 			
		}

		// 给绑定手机发送手机验证码
		function sendRand_oldMobile() {
			//手机号规则
			var mobileReg = /^(((13[0-9]{1})|(14[0-9]{1})|(17[0-3]{1})|(17[6-8]{1})|(15[0-3]{1})|(15[5-9]{1})|(18[0-9]{1}))+\d{8})$/;
			
			var mobile = $('#mobile').val();
			
			var loginName = $("#loginName").val();
			
			if (mobile.length != 11) {
				alert('请输入有效的手机号码作为用户名！');
				$('#mobile').focus();
				return;
			} else if (!mobileReg.test(mobile)) {
				alert('请输入有效的手机号码作为用户名！');
				$('#mobile').focus();
				return;
			} else if(mobile == loginName){
				alert('请更换手机号发送验证码！');
				$('#mobile').focus();
				return;
			}
			
	        var params = {
				'mobile' : mobile
			};
	        
		    $.ajax({
		    	cache : true,
		        type : "POST", // post提交方式,默认是get
		        url : "/home/sendSms", // 请求的数据源
		        async : false,
		        data : params,// 你的formid
		        success : function(data) {
		        	if(data.code == 0){
		        		var time = 60;
		                // var code = $(this);
		                $("#fsdmsg").removeClass("msgs");
		                $("#fsdmsg").addClass("msgs1");
		                $("#fsdmsg").removeAttr("onclick");
		                var t = setInterval(function() {
                            time--;
                            $("#fsdmsg").val(time  + "秒后重新获取");
                            if (time == 0) {
                                clearInterval(t);
                                $("#fsdmsg").val("重新获取");
                                $("#fsdmsg").removeClass("msgs1");
                                $("#fsdmsg").addClass("msgs");
                                $("#fsdmsg").attr("onclick","sendRand_oldMobile();");
                            }
                        }, 1000);
		        	} else if(data.code == 2){
						alert(data.msg);
					} else{
		        		alert("发送短信失败！");
		        	}
		        }
		    })
		}
	</script>
</html>