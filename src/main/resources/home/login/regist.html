<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>天津西青全民学习平台</title>
		<script type="text/javascript" src="/home/js/jquery-1.7.2.min.js"></script>
		<script type="text/javascript" src="/home/common/angular.js"></script>
		<script type="text/javascript" src="/home/common/compatibility.js"></script>
		<link type="text/css" rel="stylesheet" href="/home/css/global.css" />
		<link type="text/css" rel="stylesheet" href="/home/css/headFoot.css" />
		<link type="text/css" rel="stylesheet" href="/home/css/index.css"/>
		<link type="text/css" rel="stylesheet" href="/home/common/common.css"/>
		<link type="text/css" rel="stylesheet" href="/home/common/regist.css"/>
	</head>
	<style>
		.msgs1 {
		    background: #E6E6E6;
		    color: #818080;
		    border: 1px solid #CCCCCC;
		}
		.msgs {
		    -webkit-border-radius: .5em;
		    -moz-border-radius: .5em;
		    border-radius: .5em;
		    display: inline-block;
		    width: 100px;
		    color: #fff;
		    font-size: 14px;
		    border: 1px solid #0697DA;
		    text-align: center;
		    height: 30px;
		    line-height: 30px;
		    background: #0697DA;
		    cursor: pointer;
		}
	</style>
	<body>
		<div class="box">
			<#include "/headLoad.html">
<div class="min_h_500 ng-scope" style="margin-bottom: 30px;" ui-view=""><div class="bgfff w1200 auto mt20 fixborder ng-scope" style="position:relative;">
    <h4 class="nomol_title bb_e1">注册</h4>
    
    <!-----------------------------阅读注册协议------------------------------------->

    <!-----------------------------填写注册信息------------------------------------->
    <!-- ngIf: step==2 --><div class="register_2 ng-scope" ng-if="step==2">
        <div class="register_2_notice">
            <p><b>注意事项：</b> 以下有 <span style="color:#F00;">*</span> 标签的为必填项。</p>
            <!--<p>2、用户名、真实姓名、身份号码将作为找回密码凭证，请正确填写。</p>-->
            <!--<p>3、上海地区请选择所在街道，奉贤区街道用户请选择所在居委。</p>-->
            <!--<p>2、必填信息作为虚拟卡转换实体卡的依据，实体卡将享有更多的便利。</p>-->
        </div>
		<form id="signupForm">
		<input id="mobile" type="hidden" name="mobile" maxlength="11">
        <table cellpadding="0" cellspacing="0" border="0" class="ng-pristine ng-invalid ng-invalid-required">
            <tbody><tr>
                <td align="right" width="15%"><span style="color: red">*</span><label>用户名：</label></td>
                <td>
                    <input type="text" id="loginName" name="loginName" placeholder="请输入手机号" required="" maxlength="11" class="ng-pristine ng-valid-pattern ng-invalid ng-invalid-required">
                    <span id="dlspan" style="color: red">请使用手机号作为用户名注册用户！</span>
                    <input id="inType" type="hidden" name="inType" value="PC">
                </td>
            </tr>
            <tr>
                <td align="right"><span style="color: red">*</span><label>密码：</label></td>
                <td>
                    <div style="position: relative;">
                        <input id="password" type="password" name="password" placeholder="密码(8-30位)中必须包含字母、数字、特殊字符"  maxlength="20" class="ng-pristine ng-valid-pattern ng-invalid ng-invalid-required" required="required">
                        <span id="mmspan" style="color: red"  class="ng-hide">必填！</span>
                    </div>
                </td>
            </tr>
            <tr>
                <td align="right"><span style="color: red">*</span><label>确认密码：</label></td>
                <td>
                    <div style="position: relative;">
                        <input id="newPassword" type="password" placeholder="请输入确认密码" maxlength="20" class="form-control ng-pristine ng-valid" name="newPassword">
                        <span id="qrmmspan" style="color: red"  class="ng-hide">密码不一致！</span>
                    </div>
                </td>
            </tr>
            <tr>
                <td align="right"><span style="color: red">*</span><label>手机验证码：</label></td>
                <td>
                    <div style="position: relative;">
                        <input id="smsCode" placeholder="请输入手机验证码" type="text" maxlength="20" class="form-control ng-pristine ng-valid" name="smsCode">
                        <input type="button" id="fsdmsg" value="获取手机验证码" onclick="sendRand_oldMobile()" class="msgs" style="width:200px !important;">
                    </div>
                </td>
            </tr>
            <tr>
                <td align="right"><span style="color: red">*</span><label>所在街镇：</label></td>
                <td>
                    <select id="street" name="street" class="form-control ng-pristine ng-valid">
                    	<option value="">请输入所在街镇</option>
                        <option value="杨柳青镇">杨柳青镇</option>
                        <option value="中北镇">中北镇</option>
                        <option value="张家窝镇">张家窝镇</option>
                        <option value="精武镇">精武镇</option>
                        <option value="大寺镇">大寺镇</option>
                        <option value="辛口镇">辛口镇</option>
                        <option value="王稳庄镇">王稳庄镇</option>
                        <option value="西营门街道">西营门街道</option>
                        <option value="李七庄街道">李七庄街道</option>
                        <option value="赤龙南街道">赤龙南街道</option>
                        <option value="其他">其他</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td align="right"><label>姓名：</label></td>
                <td>
                    <input id="userName" placeholder="请输入姓名" type="text" name="userName" maxlength="20" class="ng-pristine ng-valid">
                </td>
            </tr>
            <tr>
                <td align="right"><label>昵称：</label></td>
                <td>
                    <input id="nickName" placeholder="请输入昵称" type="text" name="nickName" maxlength="20" class="ng-pristine ng-valid">
                </td>
            </tr>
            <tr>
                <td align="right"><label>性别：</label></td>
                <td>
                    <select id="sex" name="sex" class="form-control ng-pristine ng-valid">
                        <option value="保密">保密</option>
                        <option value="男">男</option>
                        <option value="女">女</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td align="right"><label>身份证号：</label></td>
                <td>
                    <input id="idCard" placeholder="请输入身份证号" type="text" name="idCard"  maxlength="20"  class="ng-pristine ng-valid ng-valid-pattern">
                    <span style="color: red" ng-show="(isSubmit || myForm.idCard.$dirty) &amp;&amp; myForm.idCard.$error.pattern" class="ng-hide">请输入正确的身份证号！</span>
                </td>
            </tr>
            <!-- <tr>
                <td align="right"><label>手机号码：</label></td>
                <td>
                    <input id="mobile" type="text" name="mobile" maxlength="20"  class="ng-pristine ng-valid ng-valid-pattern">
                    <span style="color: red" ng-show="(isSubmit || myForm.phone.$dirty) &amp;&amp; myForm.phone.$error.pattern" class="ng-hide">请输入正确的手机号！</span>
                </td>
            </tr> -->
            <tr>
                <td align="right"><label>邮箱：</label></td>
                <td>
                    <input id="email" type="email" name="email" placeholder="请输入邮箱" maxlength="50" class="ng-pristine ng-valid ng-valid-email">
                    <span style="color: red" ng-show="(isSubmit || myForm.email.$dirty) &amp;&amp; myForm.email.$error.email" class="ng-hide">邮箱格式错误！</span>
                </td>
            </tr>
            <tr>
                <td align="right"><label>联系地址：</label></td>
                <td>
                    <input id="address" type="text" placeholder="请输入联系地址" class="form-control ng-pristine ng-valid" name="address" maxlength="100">
                </td>
            </tr>
            <tr>
                <td align="right"><label>个人简介：</label></td>
                <td>
                    <textarea id="memo" name="memo" class="form-control ng-pristine ng-valid" rows="5"></textarea>
                </td>
            </tr>
            <!--<tr>-->
            <!--<td></td>-->
            <!--<td>-->
            <!--&lt;!&ndash;<input id="checkProtocol" type="checkbox" ng-model="$parent.isOK">&ndash;&gt;-->
            <!--<a>注册协议</a>-->
            <!--</td>-->
            <!--</tr>-->
        </tbody></table>
        </form>
        <div class="tac">
            <input type="button" onClick="regist();" class="btn_orange btn" value="注册新用户" style="width:130px !important;height:30px !important;">
        </div>

    </div><!-- end ngIf: step==2 -->
    <!-----------------------------完成注册------------------------------------->
    <!-- ngIf: step==3 -->
</div>
</div>
			<#include "/foot.html">
		</div>
	</body>
	<script type="text/javascript">
		function regist() {
			//手机号规则
			var mobileReg = /^(((13[0-9]{1})|(14[0-9]{1})|(17[0-3]{1})|(17[6-8]{1})|(15[0-3]{1})|(15[5-9]{1})|(18[0-9]{1}))+\d{8})$/;
			
			var loginName = $('#loginName').val();
			var password = $('#password').val();
			var newPassword = $('#newPassword').val();
			var smsCode = $('#smsCode').val();
			var userName = $('#userName').val();
			var nickName = $('#nickName').val();
			var sex = $('#sex').val();
			var idCard = $('#idCard').val();
			//用手机号作为用户名
			var mobile = $('#loginName').val();
			var email = $('#email').val();
			var address = $('#address').val();
			var street = $('#street').val();
			var memo = $('#memo').val();
			var inType = $('#inType').val();
			
			if (loginName == '') {
				alert('用户名不能为空！');
				$('#loginName').focus();
				return;
			} else if (loginName.length != 11) {
				alert('请输入有效的手机号码作为用户名！');
				$('#loginName').focus();
				return;
			} else if (!mobileReg.test(loginName)) {
				alert('请输入有效的手机号码作为用户名！');
				$('#loginName').focus();
				return;
			}
			if(!password){
				alert('请输入密码！');
				$('#password').focus();
				return;
			} else {
				var pwdRegex = new RegExp('(?=.*[0-9])(?=.*[a-zA-Z])(?=.*[^a-zA-Z0-9]).{8,30}');
				if(!pwdRegex.test(password)){
					alert('您的密码安全级别低（密码中必须包含字母、数字、特殊字符），请及时修改密码！');
					$('#password').focus();
					return;
				}
			}
			if(password!=newPassword){
				alert('密码不一致！');
				$('#newPassword').focus();
				return;
			}
			if(!smsCode){
				alert('请输入手机验证码！');
				$('#smsCode').focus();
				return;
			}
			if(!street){
				alert('请输入所在街镇！');
				$('#street').focus();
				return;
			}
			$('#mobile').attr("value",mobile);
			
			var params = {
					'loginName' : loginName,
					'password' : password,
					'smsCode' : smsCode,
					'street' : street,
					'userName' : userName,
					'nickName' : nickName,
					'sex' : sex,
					'idCard' : idCard,
					'mobile' : mobile,
					'email' : email,
					'address' : address,
					'memo' : memo,
					'inType' : inType
				};
			$.ajax({
				cache : true,
				type : "POST",
				url : "/home/saveUserWeb",
				data : params,// 你的formid
				async : false,
				error : function(request) {
					alert("注册失败，连接超时！");
				},
				success : function(data) {
					if (data.code == 0) {
						alert("恭喜您注册成功,正在登录网站。。。");

						//登陆用户
						var params = {
								'loginName' : loginName,
								'password' : password
							};
						$.ajax({
							cache : true,
							type : "POST",
							url : "/home/loginWeb",
							data : params,// 你的formid
							async : false,
							error : function(request) {
								alert("登录失败，连接超时！");
							},
							success : function(data) {
								if (data.code == 0) {
									window.location.href="/home";
								} else {
									alert("登录失败，用户不存在或密码错误！");
								}
				
							}
						});
/* 						//写入APP端用户
						var enc = data.enc;
						var uname = data.uname;
						var passwd = data.password;
						var params = {
								'uname' : uname,
								'enc' : enc,
								'passwd' : passwd
							};
						$.ajax({
							cache : true,
							type : "POST",
							url : "http://passport.tianfang.xuexi365.com/loginByToken",
							data : params,// 你的formid
							async : false,
							dataType: "jsonp",
							error : function(request) {
								alert("注册APP失败，连接超时！");
							},
							success : function(data) {
								if (data.ret == true) {
									//登陆用户
									var params = {
											'loginName' : loginName,
											'password' : password
										};
									$.ajax({
										cache : true,
										type : "POST",
										url : "/home/loginWeb",
										data : params,// 你的formid
										async : false,
										error : function(request) {
											alert("登录失败，连接超时！");
										},
										success : function(data) {
											if (data.code == 0) {
												window.location.href="/home";
											} else {
												alert("登录失败，用户不存在或密码错误！");
											}
							
										}
									});
								} else {
									alert("注册APP失败！");
								}
				
							}
						}); */
						
					} else if(data.code == 2){
						alert(data.msg);
					} else {
						alert("注册失败，请确认用户信息注册！");
					}
	
				}
			});
	
		}
		
		// 给绑定手机发送手机验证码
		function sendRand_oldMobile() {
			//手机号规则
			var mobileReg = /^(((13[0-9]{1})|(14[0-9]{1})|(17[0-3]{1})|(17[6-8]{1})|(15[0-3]{1})|(15[5-9]{1})|(18[0-9]{1}))+\d{8})$/;
			
			var mobile = $('#loginName').val();
			
			if (mobile.length != 11) {
				alert('请输入有效的手机号码作为用户名！');
				$('#loginName').focus();
				return;
			} else if (!mobileReg.test(mobile)) {
				alert('请输入有效的手机号码作为用户名！');
				$('#loginName').focus();
				return;
			}
			
	        var params = {
				'mobile' : mobile
			};
	        
		    $.ajax({
		    	cache : true,
		        type : "POST", // post提交方式,默认是get
		        url : "/home/sendSms", // 请求的数据源
		        async : false,
		        data : params,// 你的formid
		        success : function(data) {
		        	if(data.code == 0){
		        		var time = 60;
		                // var code = $(this);
		                $("#fsdmsg").removeClass("msgs");
		                $("#fsdmsg").addClass("msgs1");
		                $("#fsdmsg").removeAttr("onclick");
		                var t = setInterval(function() {
                            time--;
                            $("#fsdmsg").val(time  + "秒后重新获取");
                            if (time == 0) {
                                clearInterval(t);
                                $("#fsdmsg").val("重新获取");
                                $("#fsdmsg").removeClass("msgs1");
                                $("#fsdmsg").addClass("msgs");
                                $("#fsdmsg").attr("onclick","sendRand_oldMobile();");
                            }
                        }, 1000);
		        	} else if(data.code == 2){
						alert(data.msg);
					} else{
		        		alert("发送短信失败！");
		        	}
		        }
		    })
		}
	</script>
</html>
